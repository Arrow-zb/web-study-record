[toc]

# 3. 文本处理

本节将介绍 Linux 下使用 Shell 处理文本时最常用的工具： find、grep、xargs、sort、uniq、tr、cut、paste、wc、sed、awk;

## 3.1 find 文件查找

查找 txt 和 pdf 文件：

```bash
find . \( -name "*.txt" -o -name "*.pdf"\) -print
```

正则方式查找 .txt  和 .pdf：

```bash
find . -regex ".*\(\.txt|\.pdf\)$"
```

`-iregex`： 忽略大小写正则

否定参数，查找所有非 `txt` 文本：

```bash
find . ! -name "*.txt" -print
```

指定搜索深度，打印出当前目录的文件（深度为1）：

```bash
find . -maxdepth 1 -type f
```

### 1. 定制搜索

- 按类型搜索

  ```bash
  find . -type d -print // 只列出所有目录
  ```

  `-type` f 文件 / `|` 符号连接 / d 目录

  `find` 支持的文件检索类型可以区分普通文件和符号连接、目录，但是二进制文件和普通文本无法直接通过find的类型区分出来


  file 命令可以检查文件具体类型 （二进制或文本）

  ```bash
  file redis-cli # 二进制文件
  
  aispeechdeMacBook-Air:web-study-record aispeech$ file README.md 
  README.md: UTF-8 Unicode text
  ```

  所以，可以使用一下命令组合来实现查找本地目录下的所有二进制文件：

  ```bash
  ls -lrt | awk '{print $9}' | xargs file | grep ELF | awk '{print $1}' | tr -d ':'
  ```

  - 按时间搜索

    - `-atime` 访问时间（单位是天，分钟单位则是 `-amin`, 以下类似）
    - `-mtime` 修改时间 （内容被修改）
    - `-ctime` 变化事件 （元数据或权限变化）

    最近第七天被访问过的所有文件：

    ```bash
    find . -atime 7 -type f -print
    ```

    最近 7 天内被访问过的所有文件

    ```bash
    find . -atime -7 type f -print
    ```

    查询7天前被访问过的所有文件

    ```bash
    find . -atime +7 type f -print
    ```

  - 按大小搜索

    寻找大于 2K 的文件

    ```bash
    find . -type f -size +2k
    ```

  - 按权限查找

    ```bash
    find . -type f -perm 644 -print
    ```

  - 按用户查找

    ```bash
    find . -type f -user weber -print
    ```

## 2. 找到的后续动作

- 删除

  删除当前目录下所有的 `swp` 文件：

  ```bash
  find . -type f -name "*.swp" -delete
  ```

  另一种语法

  ```bash
  find . -type f -name "*.swp" | xargs rm 
  ```

- 执行动作（强大的exec）

  将当前目录下的所有权变更为 weber

  ```bash
  find . -type f -user root -exec chown weber {} \;
  ```

  注： `{}` 是一个特殊的字符串，对于每一个匹配到的文件，`{}` 会被替换成响应的文件名

  将找到的文件全都 `copy` 到另一个目录

  ```bash
  find . -type f -mtime +10 -name "*.txt" -exec cp {} OLD \;
  ```

- 结合多个命令

  如果需要后续执行多个命令，可以将多个命令写成一个脚本。然后 `-exec` 调用时执行脚本即可

  ```bash
  -exec ./commands.sh {} \;
  ```

### 3. `-print` 的定界符

默认使用  `\n` 作为文件的定界符；

`-printO` 使用 `\O` 作为文件的定界符，这样就可以搜索包含空格的文件。

## 3.2 grep 文本搜索

```bash
grep match_patten file // 默认访问匹配行
```

常用参数：

- `-o` 只输出匹配的文本行 VS `-v` 只输出没有匹配的文本行

-  `-c` 统计文本中包含文本的次数

  ```bash
  grep -c "text" filename
  ```

- `-n` 打印匹配的行号

- `-i` 搜索时忽略大小写

- `-l` 只打印文件名

在多级目录中对文本递归搜索（程序员搜代码的最爱）

```bash
grep "class" . -R -n
```

匹配多个模式：

```bash
grep -e "class" -e "vitural" file
```

`grep` 输出以 O 作为结尾符的文件名（-z）:

```bash
grep "test" file* -lZ | xargs -O rm 
```

综合应用：将日志中的所有带 where 条件的 sql 查找查找出来

```bash
cat LOG * | tr a-z A-Z | grep "FROM" | grep "WHERE" > b
```

## 3.3 xargs 命令行参数转换

xargs 能够输入数据转化为特定命令的命令行参数；这样，可以配合很多命令来组合使用。比如 `grep`，比如 `find`； `-` 将多行输出转化为单行输出。

```bash
cat file.txt | xargs
```

n是多行文本间的定界符

- 将单行转为多行输出

  ```bash
  cat single.txt | xargs -n 3
  ```

  `-n`: 指定每行显示的字段数

  `xargs` 参数说明

  - `-d` 定义定界符（默认为空格 多行的定界符为 n）
  - `-n` 指定输出为多行
  - `-I {}` 指定替换字符串，这个字符串在 `xargs` 扩展时会被替换掉，用于待执行的命令需要多个参数时
  -  `-O` 指定 O 为定界符

## 3.4 sort 排序

字段说明

- `-n` 按数字进行排序 VS `-d` 按字典序进行排序

- `-r`逆序排序

- `-k N ` 指定按第 N 列排序

  ```bash
  sort -nrk 1 data.txt
  sort -bd data  // 忽略想空格之类的前导空白字符
  ```

## 3.5 uniq 消除重复行

- 消除重复行

  ```bash
  sort unsort.txt | uniq
  ```

- 统计各行在文件中出现的次数

  ```bash
  sort unsort.txt | uniq -c
  ```

- 找出重复行

  ```bash
  sort unsort.txt | uniq -d
  ```

  可指定每行中需要比较的重复内容： -s 开始位置 -w比较字符数











