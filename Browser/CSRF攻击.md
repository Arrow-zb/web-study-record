[toc]

# CSRF 攻击

## 1. 前言

CSRF 攻击： CSRF 全称跨站点请求伪造（Cross-Site Request Forgery), 简单理解为：

- 攻击者盗用了你的身份，使用你的身份发送恶意的请求，因为身份是你的经过认证的，因此服务器认为这个请求是合理的，但是却实现了攻击者所期望的操作，比如以你的名义发送邮件消息等。

CSRF 攻击原理和过程如下：

其中 Web A为存在 CSRF 漏洞的网站，Web B 为攻击者构建的恶意网站，User C 为 Web A 网站的合法用户。

1. 用户 C 打开浏览器，访问受信任网站 A，输入用户名和密码请求登录网站A;
2. 用户信息通过验证，网站 A 生成 Cookie 并返回给客户端，此时用户 A 身份被认证以及客户端记录下来了，用户 A 可以正常发送请求到服务器 A
3. 用户为退出网站 A 之前，在统一浏览器中打开一个 TAB 访问网站 B；
4. 网站 B 接收到用户请求后，返回一些攻击性代码，并发出一个请求访问第三方站点 Web A；
5. 请求携带用户A 的 cookie向服务器 A 发起请求。由于 A 是被验证过的，因此服务器认为请求是合法的，执行请求（恶意行为）

## 2. CSRF 漏洞检测

可以用一个简单的方法来抓取一个正常请求的数据包，去掉 referer 子弹后再重新提交，如果还有效，就基本可以确定存在 CSRF 漏洞。

## 3. 防御 CSRF 攻击

大致三种策略：

1. 验证 HTTP referer 字段；
2. 在请求地址中添加 token 并验证；
3. 在 http 头中自定义属性并验证。

### 3.1 验证referer

referer 会记录请求的来源地址，因此这种方法最为简单，只要在服务器检查请求的 referer 是否是本域。但是这种方法并不是万无一失的，referer是由浏览器提供的，虽然 HTTP 协议上有明确的要求，但并不是所有浏览的 referer 实现都一致，同时referer毕竟是记录了用户的隐私，因此有的用户关闭了referer，这都是问题。

### 3.2 请求地址中添加 token

token 可以在用户登陆后产生并放于 session 之中，然后在每次请求时把 token 从 session 中拿出，与请求中的 token 进行比对，但这种方法的难点在于如何把 token 以参数的形式加入请求。

###  3.3 在 http 头中自定义属性并验证

这种方法也是使用 token 并进行验证，和上一种方法不同的是，这里并不是把 token 以参数的形式置于 HTTP 请求之中，而是把它放到 HTTP 头中自定义的属性里。